"use client";
import { useParams, useRouter } from "next/navigation";
import { useEffect, useState, Suspense } from "react";
import Link from "next/link";

interface VulnerabilityDetail {
  id: string;
  title: string;
  severity: "Critical" | "High" | "Medium" | "Low";
  package: string;
  cve?: string;
  priorityScore: number;
  aiExplanation: string;
  remediation: string;
  falsePositiveRisk: "Low" | "Medium" | "High";
  affectedFiles?: string[];
}

function VulnerabilityDetailContent() {
  const params = useParams();
  const router = useRouter();
  const [vulnerability, setVulnerability] =
    useState<VulnerabilityDetail | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const analysisId = params.analysisId as string;
        const vulnId = params.id as string;

        console.log("Fetching analysis:", analysisId, "vulnerability:", vulnId);

        const res = await fetch(`/api/analyze?id=${analysisId}`);
        const data = await res.json();

        console.log("API Response status:", res.ok);
        console.log("API Response data:", data);

        if (res.ok) {
          if (!data.prioritizedIssues) {
            console.error("No prioritizedIssues in response:", data);
            setError("Invalid analysis data structure");
            setLoading(false);
            return;
          }

          console.log(
            "Looking for vulnerability with ID:",
            vulnId,
            typeof vulnId
          );
          console.log(
            "Available IDs:",
            data.prioritizedIssues.map((i: any) => ({
              id: i.id,
              type: typeof i.id,
            }))
          );

          // Convert both to strings for comparison since URL params are always strings
          const vuln = data.prioritizedIssues.find(
            (issue: VulnerabilityDetail) => String(issue.id) === String(vulnId)
          );

          if (vuln) {
            console.log("Found vulnerability:", vuln);
            setVulnerability(vuln);
          } else {
            console.error(
              "Vulnerability not found. Available:",
              data.prioritizedIssues.length
            );
            console.error("First issue sample:", data.prioritizedIssues[0]);
            setError("Vulnerability not found");
          }
        } else {
          console.error("API error:", data);
          setError(data.error || "Failed to load data");
        }
      } catch (err: any) {
        console.error("Fetch error:", err);
        setError(err.message || "Failed to fetch vulnerability");
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [params]);

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "Critical":
        return "text-red-400 bg-red-500";
      case "High":
        return "text-orange-400 bg-orange-500";
      case "Medium":
        return "text-yellow-400 bg-yellow-500";
      case "Low":
        return "text-blue-400 bg-blue-500";
      default:
        return "text-gray-400 bg-gray-500";
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-linear-to-br from-slate-900 via-slate-800 to-cyan-900 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-cyan-300 text-lg">
            Loading vulnerability details...
          </p>
        </div>
      </div>
    );
  }

  if (error || !vulnerability) {
    return (
      <div className="min-h-screen bg-linear-to-br from-slate-900 via-slate-800 to-cyan-900 flex items-center justify-center p-8">
        <div className="max-w-md w-full bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl shadow-2xl p-8 text-center border border-cyan-500">
          <div className="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 className="text-2xl font-bold text-white mb-4">Error</h2>
          <p className="text-gray-300 mb-6">
            {error || "Vulnerability not found"}
          </p>
          <button
            onClick={() => router.back()}
            className="inline-block px-6 py-3 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition-colors font-semibold"
          >
            Go Back
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-linear-to-br from-slate-900 via-slate-800 to-cyan-900 p-6">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <button
            onClick={() => router.back()}
            className="text-cyan-400 hover:text-cyan-300 transition-colors mb-4 inline-flex items-center gap-2"
          >
            ‚Üê Back to Dashboard
          </button>
          <div className="flex items-start justify-between gap-4">
            <div className="flex-1">
              <h1 className="text-4xl font-bold text-white mb-4">
                {vulnerability.title}
              </h1>
              <div className="flex items-center gap-4 flex-wrap">
                <span
                  className={`px-4 py-2 rounded-lg font-bold bg-opacity-20 ${getSeverityColor(
                    vulnerability.severity
                  )}`}
                >
                  {vulnerability.severity}
                </span>
                {vulnerability.cve && (
                  <span className="px-4 py-2 bg-slate-800 bg-opacity-50 text-cyan-300 rounded-lg font-mono">
                    {vulnerability.cve}
                  </span>
                )}
                <span className="px-4 py-2 bg-slate-800 bg-opacity-50 text-white rounded-lg">
                  Package:{" "}
                  <code className="text-cyan-300">{vulnerability.package}</code>
                </span>
              </div>
            </div>
            <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl p-6 text-center border border-cyan-500">
              <div className="text-5xl font-bold text-cyan-400 mb-2">
                {vulnerability.priorityScore}
              </div>
              <div className="text-gray-400 text-sm">Priority Score</div>
            </div>
          </div>
        </div>

        {/* AI Analysis */}
        <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl p-8 mb-6 border border-gray-700">
          <div className="flex items-center gap-3 mb-4">
            <span className="text-3xl">ü§ñ</span>
            <h2 className="text-2xl font-bold text-white">AI Analysis</h2>
          </div>
          <p className="text-gray-300 text-lg leading-relaxed">
            {vulnerability.aiExplanation}
          </p>
        </div>

        {/* Remediation */}
        <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl p-8 mb-6 border border-gray-700">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <span className="text-3xl">üîß</span>
              <h2 className="text-2xl font-bold text-white">
                Remediation Steps
              </h2>
            </div>
            <button
              onClick={() => copyToClipboard(vulnerability.remediation)}
              className="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition-colors text-sm font-semibold flex items-center gap-2"
            >
              {copied ? "‚úì Copied!" : "üìã Copy"}
            </button>
          </div>
          <div className="bg-slate-900 border border-gray-700 rounded-lg p-6">
            <pre className="text-cyan-300 font-mono text-sm whitespace-pre-wrap">
              {vulnerability.remediation}
            </pre>
          </div>
        </div>

        {/* False Positive Risk */}
        <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl p-8 mb-6 border border-gray-700">
          <div className="flex items-center gap-3 mb-4">
            <span className="text-3xl">‚öñÔ∏è</span>
            <h2 className="text-2xl font-bold text-white">
              False Positive Assessment
            </h2>
          </div>
          <div className="flex items-center gap-4">
            <span className="text-gray-300">Risk Level:</span>
            <span
              className={`px-4 py-2 rounded-lg font-bold ${
                vulnerability.falsePositiveRisk === "High"
                  ? "bg-red-500 bg-opacity-20 text-red-400"
                  : vulnerability.falsePositiveRisk === "Medium"
                  ? "bg-yellow-500 bg-opacity-20 text-yellow-400"
                  : "bg-green-500 bg-opacity-20 text-green-400"
              }`}
            >
              {vulnerability.falsePositiveRisk}
            </span>
          </div>
          <p className="text-gray-400 mt-4">
            {vulnerability.falsePositiveRisk === "Low"
              ? "This vulnerability is highly likely to be genuine and should be addressed."
              : vulnerability.falsePositiveRisk === "Medium"
              ? "This vulnerability may require additional validation before taking action."
              : "This vulnerability has a high chance of being a false positive. Verify before investing significant resources."}
          </p>
        </div>

        {/* Affected Files */}
        {vulnerability.affectedFiles &&
          vulnerability.affectedFiles.length > 0 && (
            <div className="bg-slate-800 bg-opacity-50 backdrop-blur rounded-2xl p-8 border border-gray-700">
              <div className="flex items-center gap-3 mb-4">
                <span className="text-3xl">üìÅ</span>
                <h2 className="text-2xl font-bold text-white">
                  Affected Locations
                </h2>
              </div>
              <ul className="space-y-2">
                {vulnerability.affectedFiles.map((file, idx) => (
                  <li
                    key={idx}
                    className="flex items-center gap-3 text-gray-300"
                  >
                    <span className="text-cyan-400">‚Ä¢</span>
                    <code className="px-3 py-2 bg-slate-900 rounded text-cyan-300 font-mono text-sm">
                      {file}
                    </code>
                  </li>
                ))}
              </ul>
            </div>
          )}

        {/* Quick Actions */}
        <div className="mt-8 flex gap-4">
          <Link
            href={`/dashboard?id=${params.analysisId}`}
            className="px-6 py-3 bg-slate-800 bg-opacity-50 hover:bg-opacity-70 text-white rounded-lg transition-colors font-semibold border border-gray-700"
          >
            View All Vulnerabilities
          </Link>
          {vulnerability.cve && (
            <a
              href={`https://nvd.nist.gov/vuln/detail/${vulnerability.cve}`}
              target="_blank"
              rel="noopener noreferrer"
              className="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition-colors font-semibold"
            >
              View in NVD Database ‚Üí
            </a>
          )}
        </div>
      </div>
    </div>
  );
}

export default function VulnerabilityDetailPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen bg-linear-to-br from-slate-900 via-slate-800 to-cyan-900 flex items-center justify-center">
          <div className="text-center">
            <div className="w-16 h-16 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-cyan-300 text-lg">
              Loading vulnerability details...
            </p>
          </div>
        </div>
      }
    >
      <VulnerabilityDetailContent />
    </Suspense>
  );
}
